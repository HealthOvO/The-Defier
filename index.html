<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Defier - 逆命者</title>
    <meta name="description" content="一款基于东方仙侠的卡牌Roguelike游戏，逆天改命，盗取法则，成为真正的逆命者！">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/card-detail.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/pvp.css">
    <link rel="stylesheet" href="css/events.css">
    <link rel="stylesheet" href="css/purification.css">
</head>

<body>
    <!-- 主菜单 -->
    <div id="main-menu" class="screen active">
        <!-- New Background Layers -->
        <div class="ink-canvas"></div>
        <div class="fog-layer layer-1"></div>
        <div class="fog-layer layer-2"></div>
        <div class="void-particles" id="void-particles"></div>

        <div class="menu-content">
            <div class="game-logo">
                <div class="title-container">
                    <h1 class="title-cn">逆命者</h1>
                    <div class="ink-stroke"></div>
                </div>
                <h2 class="title-en">THE DEFIER</h2>
            </div>

            <div class="game-description">
                <p>天道无情，命环为锁，众生皆困囹圄。</p>
                <p>残次印记者林风，获得神秘古玉，开启【盗取法则】之能。</p>
                <p>三千大道，只取一瓢。以凡人之躯，窃取天地法则。</p>
                <p><strong>十八层天域试炼，激战百种妖魔，收集数百张技能牌组。</strong></p>
                <p>这一次，不为长生，只为——<span style="color: var(--accent-gold); font-weight: bold;">逆天改命！</span></p>
            </div>

            <div class="menu-buttons">
                <!-- Talisman Style Buttons -->
                <button class="talisman-btn primary" id="continue-game-btn" onclick="game.continueGame()"
                    style="display: none;">
                    <div class="talisman-paper"></div>
                    <div class="talisman-content">
                        <span class="btn-icon">▶️</span>
                        <span class="btn-text">继续冒险</span>
                    </div>
                </button>

                <button class="talisman-btn primary" id="new-game-btn" onclick="game.openSaveSlotsWithSync()">
                    <div class="talisman-paper"></div>
                    <div class="talisman-content">
                        <span class="btn-icon">⚔️</span>
                        <span class="btn-text">新的轮回</span>
                    </div>
                </button>

                <button class="talisman-btn" id="pvp-btn" onclick="game.showScreen('pvp-screen'); PVPScene.onShow()">
                    <div class="talisman-paper"></div>
                    <div class="talisman-content">
                        <span class="btn-icon">🌩️</span>
                        <span class="btn-text">天道榜</span>
                    </div>
                </button>

                <button class="talisman-btn secondary" id="login-btn" onclick="game.showLoginModal()">
                    <div class="talisman-paper"></div>
                    <div class="talisman-content">
                        <span class="btn-icon">☁️</span>
                        <span class="btn-text">登入轮回</span>
                    </div>
                </button>
            </div>

            <div class="menu-utilities">
                <div class="util-btn-wrapper">
                    <button class="util-btn" onclick="game.showPlayerInfo()">
                        <span class="btn-icon">🧙</span>
                    </button>
                    <span class="util-label">角色信息</span>
                </div>
                <div class="util-btn-wrapper">
                    <button class="util-btn" onclick="game.showScreen('collection')">
                        <span class="btn-icon">📚</span>
                    </button>
                    <span class="util-label">法则图鉴</span>
                </div>
                <div class="util-btn-wrapper">
                    <button class="util-btn" onclick="game.showAchievements()">
                        <span class="btn-icon">🏆</span>
                    </button>
                    <span class="util-label">成就殿堂</span>
                </div>
                <div class="util-btn-wrapper">
                    <button class="util-btn" onclick="game.showTreasureCompendium()">
                        <span class="btn-icon">🎒</span>
                    </button>
                    <span class="util-label">法宝图鉴</span>
                </div>
                <div class="util-btn-wrapper">
                    <button class="util-btn" onclick="game.showGameIntro()">
                        <span class="btn-icon">📖</span>
                    </button>
                    <span class="util-label">游戏介绍</span>
                </div>
            </div>
            <div class="version-info">v5.0 最终版 | 逆命轮回·天道终焉</div>
        </div>
    </div>

    <!-- PVP 界面 (天道榜) -->
    <!-- PVP 界面 (天道榜 - Ink & Gold Redesign) -->
    <div id="pvp-screen" class="screen">
        <!-- Background Layers -->
        <div class="void-bg"></div>
        <div class="ink-overlay"></div>
        <div class="void-particles" style="opacity: 0.3;"></div>

        <div class="screen-header transparent">
            <button class="back-btn" onclick="game.showScreen('main-menu')">
                <span class="btn-icon">↩</span>
            </button>
            <div class="header-title-group">
                <h2 class="ink-title">天道榜</h2>
                <div class="sub-title">HEAVENLY RANKING</div>
            </div>
            <div class="player-rank-badge">
                <div class="rank-icon-frame">
                    <span id="my-rank-tier">潜龙</span>
                </div>
                <span id="my-rank-score">1000</span>
            </div>
        </div>

        <div class="pvp-layout-split">
            <!-- Left: Navigation Runes -->
            <div class="pvp-nav-sidebar">
                <button class="rune-tab active" onclick="PVPScene.switchTab('ranking')">
                    <div class="rune-icon-container">
                        <span class="rune-icon">📜</span>
                    </div>
                    <span class="rune-name">天道榜</span>
                </button>
                <button class="rune-tab" onclick="PVPScene.switchTab('defense')">
                    <div class="rune-icon-container">
                        <span class="rune-icon">🛡️</span>
                    </div>
                    <span class="rune-name">护山阵</span>
                </button>
                <button class="rune-tab" onclick="PVPScene.switchTab('shop')">
                    <div class="rune-icon-container">
                        <span class="rune-icon">🏯</span>
                    </div>
                    <span class="rune-name">诸天阁</span>
                </button>
            </div>

            <!-- Right: Content Area -->
            <div class="pvp-content-container">
                <!-- Ranking Tab -->
                <div id="tab-ranking" class="pvp-tab-pane active">
                    <div class="ranking-scroll-area" id="ranking-list">
                        <!-- Dynamic Jade Slips -->
                        <div class="loading-ink">
                            <div class="ink-drop"></div>
                            <span>读取天机中...</span>
                        </div>
                    </div>

                    <div class="pvp-nav-footer">
                        <button class="challenge-btn pulse" onclick="PVPScene.findMatch()">
                            <span class="btn-glow"></span>
                            <span class="text">⚔️ 论道切磋</span>
                        </button>
                    </div>
                </div>

                <!-- Defense Tab -->
                <!-- Defense Tab (Hushan Formation) -->
                <div id="tab-defense" class="pvp-tab-pane" style="display:none;">
                    <div class="defense-layout-split">
                        <!-- Left: Formation Visualizer -->
                        <div class="formation-visualizer-panel">
                            <div class="formation-visual-container">
                                <div class="formation-core-rings" id="formation-core-rings">
                                    <div class="rune-ring ring-outer"></div>
                                    <div class="rune-ring ring-middle"></div>
                                    <div class="rune-ring ring-inner"></div>
                                    <div class="core-gem-center">
                                        <div class="pulse-energy"></div>
                                    </div>
                                </div>
                                <div class="formation-stats-overlay">
                                    <div class="stat-row">
                                        <span class="label">阵法强度</span>
                                        <span class="value" id="def-power-val">---</span>
                                    </div>
                                    <div class="stat-row">
                                        <span class="label">运行状态</span>
                                        <span class="value status-inactive" id="formation-status-text">未激活</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right: Controls -->
                        <div class="defense-controls-panel">
                            <div class="control-group">
                                <h3 class="control-header">
                                    <span class="icon">🔮</span> 阵灵道心
                                </h3>
                                <div class="dao-heart-selector">
                                    <div class="dao-card" data-val="balanced"
                                        onclick="PVPScene.selectPersonality('balanced')">
                                        <div class="card-icon">⚖️</div>
                                        <div class="card-name">万法自然</div>
                                        <div class="card-desc">平衡之道</div>
                                    </div>
                                    <div class="dao-card" data-val="slaughter"
                                        onclick="PVPScene.selectPersonality('slaughter')">
                                        <div class="card-icon">⚔️</div>
                                        <div class="card-name">杀伐证道</div>
                                        <div class="card-desc">进攻优先</div>
                                    </div>
                                    <div class="dao-card" data-val="longevity"
                                        onclick="PVPScene.selectPersonality('longevity')">
                                        <div class="card-icon">🐢</div>
                                        <div class="card-name">长生久视</div>
                                        <div class="card-desc">生存优先</div>
                                    </div>
                                </div>
                                <div class="dao-description-box" id="dao-desc-text">
                                    请选择阵灵的道心倾向，这将决定护山阵在自动战斗中的策略。
                                </div>
                            </div>

                            <div class="control-group">
                                <h3 class="control-header">
                                    <span class="icon">🛡️</span> 护山大阵
                                </h3>
                                <div class="formation-activation-area">
                                    <label class="seal-switch-container">
                                        <input type="checkbox" id="guardian-formation"
                                            onchange="PVPScene.updateFormationVisuals()">
                                        <div class="seal-slider">
                                            <span class="seal-face off">封</span>
                                            <span class="seal-face on">解</span>
                                        </div>
                                    </label>
                                    <div class="activation-info">
                                        <p class="highlight">开启后自动应战</p>
                                        <p class="sub-text">消耗灵石维持运转</p>
                                    </div>
                                </div>
                            </div>

                            <div class="control-actions">
                                <button class="ink-btn-large" onclick="PVPScene.uploadDefense()">
                                    <span class="ink-flow-effect"></span>
                                    <span class="btn-icon">🌩️</span>
                                    <span class="btn-text">注入神念 (上传数据)</span>
                                </button>
                                <div class="last-sync-time" id="def-time">上次注入: 无记录</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shop Tab (Zhutian Pavilion) -->
            <div id="tab-shop" class="pvp-tab-pane" style="display:none;">
                <div class="shop-layout">
                    <!-- Left: Categories -->
                    <div class="shop-sidebar">
                        <div class="shop-category active" onclick="PVPScene.filterShop('all')">
                            <span class="cat-icon">💠</span>
                            <span class="cat-name">全部</span>
                        </div>
                        <div class="shop-category" onclick="PVPScene.filterShop('cards')">
                            <span class="cat-icon">📜</span>
                            <span class="cat-name">秘籍</span>
                        </div>
                        <div class="shop-category" onclick="PVPScene.filterShop('items')">
                            <span class="cat-icon">💊</span>
                            <span class="cat-name">丹药</span>
                        </div>
                        <div class="shop-category" onclick="PVPScene.filterShop('cosmetics')">
                            <span class="cat-icon">👘</span>
                            <span class="cat-name">外观</span>
                        </div>
                    </div>

                    <!-- Right: Content -->
                    <div class="shop-content-area">
                        <div class="shop-header-bar">
                            <div class="shop-title-rune">诸天万象</div>
                            <div class="shop-wallet-container">
                                <span class="wallet-icon">🪙</span>
                                <span class="wallet-amount" id="shop-wallet-amount">0</span>
                                <span class="wallet-label">天道币</span>
                            </div>
                        </div>

                        <div class="shop-scroll-view">
                            <div class="shop-unified-grid" id="shop-unified-grid">
                                <!-- Dynamic Items -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- 角色选择界面 -->
    <div id="character-selection-screen" class="screen">
        <div class="screen-header">
            <button class="back-btn" onclick="game.showScreen('main-menu')">← 返回</button>
            <h2>选择你的命运</h2>
        </div>
        <div class="character-selection-container" id="character-selection-container">
            <!-- 动态生成 -->
        </div>
        <div class="character-selection-footer">
            <button class="menu-btn primary" id="confirm-character-btn" onclick="game.confirmCharacterSelection()"
                disabled>
                <span class="btn-icon">⚔️</span>
                <span class="btn-text">踏入轮回</span>
            </button>
        </div>
    </div>

    <!-- 角色选择/信息界面 (Refactored for Ink & Gold) -->
    <div id="character-select" class="screen">
        <div class="screen-header">
            <button class="back-btn" onclick="game.showScreen('main-menu')">← 返回</button>
            <h2>角色信息</h2>
        </div>

        <div class="ink-scroll-container">
            <div class="ink-scroll-content">
                <!-- Left Column: Destiny Identity -->
                <div class="char-identity-col">
                    <div class="char-name-vertical" id="info-char-name">林风</div>
                    <div class="imprint-seal" id="info-char-title">残次印记</div>

                    <div class="char-avatar-ink-wrapper">
                        <div class="ink-splash-bg"></div>
                        <div class="avatar-ink-inner" id="info-char-avatar">林风</div>
                    </div>
                </div>

                <!-- Right Column: Cultivation Stats & Biography -->
                <div class="char-details-col">
                    <!-- Spirit Tablets (Stats) -->
                    <div class="spirit-tablets-row">
                        <div class="spirit-tablet hp">
                            <span class="tablet-icon">❤️</span>
                            <span class="tablet-label">生命本源</span>
                            <span class="tablet-value" id="char-hp">80</span>
                        </div>
                        <div class="spirit-tablet energy">
                            <span class="tablet-icon">⚡</span>
                            <span class="tablet-label">灵力上限</span>
                            <span class="tablet-value" id="char-energy">3</span>
                        </div>
                        <div class="spirit-tablet draw">
                            <span class="tablet-icon">🎴</span>
                            <span class="tablet-label">神识感知</span>
                            <span class="tablet-value" id="char-draw">5</span>
                        </div>
                        <div class="spirit-tablet strength">
                            <span class="tablet-icon">💪</span>
                            <span class="tablet-label">道体强度</span>
                            <span class="tablet-value" id="char-strength">-</span>
                        </div>
                    </div>

                    <!-- Biography Scroll -->
                    <div class="bio-scroll-paper">
                        <div class="bio-content">
                            <h4><span class="section-icon">📜</span> 宿命传记</h4>
                            <p class="character-desc" id="info-char-desc">身负最残次印记，却获得神秘古玉，拥有盗取法则的能力。</p>
                        </div>
                    </div>

                    <!-- Fate Ring Hologram (Simplified for Info View) -->
                    <div class="fate-ring-info-panel">
                        <div class="ring-info-header">
                            <h4><span class="section-icon">⭕</span> 命环境界</h4>
                            <span class="ring-level-badge" id="ring-level">一阶</span>
                        </div>
                        <div class="ring-visual-mini">
                            <div class="ring-core"></div>
                            <div class="ring-orbit orbit-1"></div>
                            <div class="ring-orbit orbit-2"></div>
                        </div>
                        <div class="ring-stats-text">
                            <p>法则容量: <span id="loaded-laws">0/3</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 法则图鉴 -->
    <div id="collection" class="screen">
        <div class="screen-header">
            <button class="back-btn" onclick="game.showScreen('main-menu')">← 返回</button>
            <h2>法则图鉴</h2>
        </div>

        <div class="codex-scroll-container">
            <!-- Top Section: Law Archive -->
            <div class="codex-section">
                <div class="codex-section-header">
                    <span class="section-icon">📜</span>
                    <h3>万法归一 · 法则库</h3>
                </div>
                <div class="law-archive-grid" id="law-archive-grid">
                    <!-- Dynamic Laws -->
                </div>
            </div>

            <!-- Bottom Section: Resonance Manual -->
            <div class="codex-section">
                <div class="codex-section-header">
                    <span class="section-icon">🔮</span>
                    <h3>天道共鸣 · 羁绊录</h3>
                </div>
                <div class="resonance-manual-list" id="resonance-manual-list">
                    <!-- Dynamic Resonances -->
                </div>
            </div>
        </div>
    </div>

    <!-- 法宝图鉴 -->
    <div id="treasure-compendium" class="screen">
        <div class="screen-header">
            <button class="back-btn" onclick="game.showScreen('main-menu')">← 返回</button>
            <h2>法宝图鉴</h2>
        </div>

        <div class="treasure-compendium-layout">
            <!-- Top Stats Scroll -->
            <div class="compendium-stats-wrapper">
                <div class="compendium-stats" id="treasure-compendium-stats">
                    <!-- 收集进度 -->
                </div>
            </div>

            <!-- Main Grid Area -->
            <div class="compendium-grid-container">
                <div class="compendium-grid" id="treasure-compendium-grid">
                    <!-- 动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 关卡选择界面 -->
    <div id="realm-select-screen" class="screen">
        <div class="screen-header">
            <button class="back-btn" onclick="game.showScreen('main-menu')">← 返回</button>
            <h2>选择试炼天域</h2>
        </div>
        <div class="realm-select-layout">
            <div class="realm-list-container" id="realm-list-container">
                <!-- Realm Cards Grid/Carousel -->
            </div>
            <div class="realm-preview-panel" id="realm-preview-panel">
                <!-- Selected Realm Details -->
                <div class="realm-preview-placeholder">
                    <div class="placeholder-icon">🏔️</div>
                    <p>请选择一个天域以查看详情</p>
                </div>
                <div class="realm-preview-content" style="display:none; opacity: 0;">
                    <div class="preview-header">
                        <div class="preview-icon" id="preview-icon"></div>
                        <h3 id="preview-title"></h3>
                    </div>

                    <div class="preview-section">
                        <h4><span class="section-icon">⚔️</span> 环境法则</h4>
                        <div id="preview-env" class="preview-text"></div>
                    </div>

                    <div class="preview-section">
                        <h4><span class="section-icon">👹</span> 镇守妖尊</h4>
                        <div id="preview-boss" class="preview-text"></div>
                    </div>

                    <div class="preview-rewards">
                        <h4><span class="section-icon">🎁</span> 可能掉落</h4>
                        <div id="preview-loot" class="preview-loot-grid"></div>
                    </div>

                    <button class="menu-btn primary large" id="enter-realm-btn" disabled>
                        <span class="btn-text">踏入天域</span>
                    </button>
                    <div class="realm-cost-display" id="realm-cost-display"
                        style="display:none; color: var(--accent-gold); margin-top: 10px; font-size: 0.9rem;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 地图界面 -->
    <div id="map-screen" class="screen">
        <div class="map-header">
            <button class="back-btn" onclick="game.showScreen('realm-select-screen')">← 返回关卡选择</button>
            <div class="player-status-bar">
                <div class="status-item hp">
                    <span class="icon">❤️</span>
                    <span id="map-hp">80/80</span>
                </div>
                <div class="status-item gold">
                    <span class="icon">💰</span>
                    <span id="map-gold">0</span>
                </div>
                <div class="status-item floor">
                    <span class="icon">🏔️</span>
                    <span id="map-floor">第一重·凡尘界</span>
                </div>
            </div>
            <div id="map-treasures" class="treasures-bar"></div>
        </div>
        <div class="map-container">
            <div class="realm-title" id="realm-title">第一重·凡尘界</div>
            <div class="map-nodes" id="map-nodes">
                <!-- 动态生成节点 -->
            </div>
        </div>
        <div class="map-footer">
            <button class="menu-btn small" onclick="game.showDeck()">查看牌组</button>
            <button class="menu-btn small" onclick="game.showTreasureBag()">法宝囊</button>
            <button class="menu-btn small" onclick="game.showFateRing()">命环</button>
            <button class="menu-btn small cheat-btn" onclick="game.cheat()" style="display: none;">作弊</button>
        </div>
    </div>

    <!-- 战斗界面 -->
    <div id="battle-screen" class="screen">
        <!-- 3D 命环背景展示 -->
        <div class="battle-bg-ring" id="battle-bg-ring">
            <div class="ring-layer layer-1"></div>
            <div class="ring-layer layer-2"></div>
            <div class="ring-layer layer-3"></div>
            <div class="ring-center-gem"></div>
        </div>
        <div class="battle-container">
            <div id="battle-treasures" class="treasures-bar battle-pos"></div>
            <div id="battle-environment" class="environment-display" style="display:none;">
                <!-- 动态填充 -->
            </div>
            <!-- 敌人区域 -->
            <div class="enemy-area">
                <div class="enemy-container" id="enemy-container">
                    <!-- 动态生成敌人 -->
                </div>
            </div>

            <!-- 连击显示 -->
            <div class="combo-display" id="combo-display">
                <div class="combo-count" id="combo-count">2</div>
                <div class="combo-text">COMBO</div>
                <div class="combo-bonus" id="combo-bonus">伤害+10%</div>
            </div>

            <!-- 中间战斗区域 -->
            <div class="battle-middle">
                <div class="battle-log"></div>
            </div>

            <!-- 玩家区域 -->
            <div class="player-area">
                <div class="player-character">
                    <div class="player-avatar">
                        <div class="avatar-effects"></div>
                        <span id="player-name-display">林风</span>
                        <div id="player-buffs" class="buff-list"
                            style="position: absolute; top: -35px; width: 200%; left: -50%; justify-content: center; display: flex; flex-wrap: wrap;">
                        </div>
                    </div>
                    <div class="player-bars">
                        <div class="hp-bar">
                            <div class="bar-fill hp-fill" id="player-hp-bar"></div>
                            <span class="bar-text" id="player-hp-text">80/80</span>
                        </div>
                        <div class="block-display" id="block-display">
                            <span class="block-icon">🛡️</span>
                            <span class="block-value" id="block-value">0</span>
                        </div>
                    </div>

                    <!-- 主动技能按钮 (Refactored) -->
                    <div id="active-skill-btn" class="active-skill-container" onclick="game.activatePlayerSkill()">
                        <!-- Visual Effects Layers -->
                        <div class="skill-halo"></div>
                        <div class="skill-runes-ring"></div>
                        <div class="skill-inner-glow"></div>

                        <div class="skill-icon-wrapper">
                            <div class="skill-icon">⚡</div>
                        </div>

                        <div class="skill-cooldown-overlay"></div>
                        <div class="skill-cooldown-text"></div>

                        <!-- Ready VFX (Hidden by default) -->
                        <div class="skill-ready-particles"></div>

                        <div class="skill-tooltip ink-tooltip">
                            <div class="skill-header">
                                <div class="skill-name">逆天改命</div>
                                <div class="skill-type-badge">绝技</div>
                            </div>
                            <div class="skill-divider"></div>
                            <div class="skill-desc">丢弃手牌，抽5张牌，回3灵力</div>
                            <div class="skill-lore">“逆乱阴阳，颠倒乾坤。”</div>
                        </div>
                    </div>
                </div>

                <!-- 资源显示区域 (Vertical Layout) -->
                <div class="resources-container">
                    <div class="energy-display resource-item" data-resource="energy">
                        <div class="energy-orbs" id="energy-orbs">
                            <!-- 动态生成灵力球 -->
                        </div>
                        <span class="energy-text" id="energy-text">3/3</span>
                        <div class="resource-tooltip">灵力</div>
                    </div>
                    <!-- 奶糖容器会由JS动态创建并添加到这里 -->
                </div>
            </div>

            <!-- 手牌区域 -->
            <div class="hand-area">
                <div class="deck-pile" id="deck-pile">
                    <span class="pile-count" id="deck-count">20</span>
                    <span class="pile-label">牌库</span>
                </div>
                <div class="hand-cards" id="hand-cards">
                    <!-- 动态生成手牌 -->
                </div>
                <div class="discard-pile" id="discard-pile">
                    <span class="pile-count" id="discard-count">0</span>
                    <span class="pile-label">弃牌</span>
                </div>
            </div>

            <!-- 结束回合按钮 -->
            <button class="end-turn-btn" id="end-turn-btn" onclick="game.battle.endTurn()">
                结束回合
            </button>
        </div>
    </div>

    <!-- 战斗奖励界面 -->
    <div id="reward-screen" class="screen">
        <div class="reward-container" style="overflow-y: auto; max-height: 95vh; padding-bottom: 50px;">
            <h2 class="reward-title">战斗胜利！</h2>
            <div class="steal-chance" id="steal-section">
                <h3>🔮 法则盗取</h3>
                <p id="steal-text">你感受到敌人体内残留的法则力量...</p>
                <button class="steal-btn" id="steal-btn" onclick="game.attemptSteal()">
                    尝试盗取
                </button>
            </div>
            <div class="reward-cards" id="reward-cards">
                <!-- 动态生成奖励卡牌 -->
            </div>
            <div class="reward-resources">
                <div class="reward-item">
                    <span class="icon">💰</span>
                    <span id="reward-gold">+50 灵石</span>
                </div>
            </div>
            <div class="reward-actions">
                <button class="continue-btn" id="continue-reward-btn" onclick="game.continueAfterReward()"
                    disabled>请先选择一张卡牌</button>
                <button class="skip-reward-btn" onclick="game.skipRewardCard()">跳过卡牌 (扣20灵石)</button>
            </div>
        </div>
    </div>

    <!-- 游戏结束界面 -->
    <div id="game-over-screen" class="screen">
        <div class="game-over-container">
            <h2 class="game-over-title" id="game-over-title">陨落...</h2>
            <p class="game-over-text" id="game-over-text">逆命之路，暂时中断</p>
            <div class="run-stats">
                <div class="stat-row">
                    <span>到达层数</span>
                    <span id="stat-floor">第1层</span>
                </div>
                <div class="stat-row">
                    <span>击败敌人</span>
                    <span id="stat-enemies">0</span>
                </div>
                <div class="stat-row">
                    <span>获得法则</span>
                    <span id="stat-laws">0</span>
                </div>
            </div>
            <div class="game-over-buttons">
                <button class="menu-btn primary" onclick="game.startNewGame()">再次挑战</button>
                <button class="menu-btn secondary" id="restart-realm-btn" onclick="game.restartRealm()">重修此界
                    (消耗50%灵石)</button>
                <button class="menu-btn" onclick="game.showScreen('main-menu')">返回主菜单</button>
            </div>
        </div>
    </div>

    <!-- PVP 结算界面 -->
    <div id="pvp-result-overlay" class="screen pvp-result-overlay">
        <div class="pvp-result-container">
            <div class="result-header">
                <div class="result-title-bg"></div>
                <h1 class="result-title" id="pvp-result-title">问道成功</h1>
            </div>

            <div class="result-content">
                <div class="pvp-score-change-anim" id="pvp-score-anim-container">
                    <span class="score-label">道韵</span>
                    <span class="score-value" id="pvp-current-score">1000</span>
                    <span class="score-delta" id="pvp-score-delta">+25</span>
                </div>

                <div class="opponent-info-result">
                    <span class="vs-text">VS</span>
                    <span class="opponent-name" id="pvp-result-opponent">对手名字</span>
                    <span class="opponent-rating" id="pvp-result-opp-score">1050</span>
                </div>
            </div>

            <div class="result-actions">
                <button class="ink-btn-large" onclick="game.closePVPResult()">返回榜单</button>
            </div>
        </div>
    </div>

    <!-- 商店界面 -->
    <div id="shop-screen" class="screen">
        <div class="screen-header">
            <button class="back-btn" onclick="game.closeShop()">← 离开商店</button>
            <h2>🏪 神秘商铺</h2>
            <div class="shop-gold">
                <span class="icon">💰</span>
                <span id="shop-gold-display">0</span> 灵石
            </div>
        </div>
        <div class="shop-container">
            <div class="shop-section">
                <h3>📜 卡牌出售</h3>
                <div class="shop-cards" id="shop-cards">
                    <!-- 动态生成 -->
                </div>
            </div>
            <div class="shop-section">
                <h3>✨ 特殊服务</h3>
                <div class="shop-services" id="shop-services-container">
                    <!-- 动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 事件弹窗 -->
    <div id="event-modal" class="modal">
        <div class="modal-content event-view">
            <div class="event-header">
                <div class="event-icon" id="event-icon">❓</div>
                <h2 id="event-title">神秘事件</h2>
            </div>
            <div class="event-body">
                <p class="event-desc" id="event-desc">发生了一些事情...</p>
                <div class="event-choices" id="event-choices">
                    <!-- 动态生成选项 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 移除卡牌弹窗 -->
    <div id="remove-card-modal" class="modal">
        <div class="modal-content deck-view">
            <button class="modal-close" onclick="game.closeModal()">×</button>
            <h2>选择要移除的卡牌</h2>
            <div class="deck-cards" id="remove-card-list"></div>
        </div>
    </div>

    <!-- 卡牌详情弹窗 -->
    <div id="card-modal" class="modal">
        <div class="modal-content card-detail">
            <button class="modal-close" onclick="game.closeModal()">×</button>
            <div class="card-large" id="modal-card"></div>
        </div>
    </div>

    <!-- 牌组查看弹窗 -->
    <div id="deck-modal" class="modal">
        <div class="modal-content deck-view">
            <button class="modal-close" onclick="game.closeModal()">×</button>
            <h2>当前牌组</h2>
            <div class="deck-cards" id="deck-view-cards"></div>
        </div>
    </div>

    <!-- 命环弹窗 (New 3D) -->
    <div id="ring-modal" class="modal">
        <div class="ring-scene-container">
            <button class="modal-close-floating" onclick="game.closeModal()">×</button>

            <!-- 3D Scene Area -->
            <div class="ring-scene">
                <div class="ring-system" id="ring-system-3d">
                    <!-- Dynamics Rings go here -->
                </div>
            </div>

            <!-- 2D UI Overlay -->
            <div class="ring-ui-overlay">
                <!-- Left: Stats -->
                <div class="ring-ui-panel left">
                    <div class="panel-header">
                        <h2 id="modal-ring-name">命环名称</h2>
                        <div class="ring-level-badge" id="modal-ring-level">一阶</div>
                    </div>
                    <div class="panel-body">
                        <div class="exp-bar-container">
                            <div class="exp-bar-fill" id="modal-ring-exp-bar"></div>
                            <span class="exp-text" id="modal-ring-exp-text">0/100</span>
                        </div>
                        <div class="stats-list" id="modal-ring-stats">
                            <!-- Stats -->
                        </div>
                        <div class="path-bonus" id="modal-ring-path">
                            <!-- Path Bonus -->
                        </div>
                    </div>
                </div>

                <!-- Right: Law Library -->
                <div class="ring-ui-panel right">
                    <div class="panel-header">
                        <h3>法则库</h3>
                        <span class="count" id="library-count">0</span>
                    </div>
                    <div class="law-library-grid" id="modal-law-library">
                        <!-- Laws -->
                    </div>
                    <div class="resonance-area" id="modal-resonance">
                        <!-- Resonance -->
                    </div>
                </div>

                <!-- Bottom: Context Action -->
                <div class="ring-ui-footer" id="ring-ui-footer">
                    <p class="instruction-text">点击法则槽位进行装配或卸下</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 技能确认弹窗 -->
    <div id="skill-confirm-modal" class="modal">
        <div class="modal-content" style="text-align: center; max-width: 400px;">
            <button class="modal-close" onclick="game.closeModal()">×</button>
            <h2 id="skill-confirm-title" style="color: var(--accent-gold); margin-bottom: 20px;">技能确认</h2>
            <div id="skill-confirm-icon" style="font-size: 4rem; margin: 20px 0;">⚡</div>
            <p id="skill-confirm-desc"
                style="font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 30px; line-height: 1.6;">
            </p>
            <div class="skill-confirm-actions" style="display: flex; justify-content: center; gap: 20px;">
                <button class="menu-btn primary small" onclick="game.confirmActivateSkill()">释放技能</button>
                <button class="menu-btn small" onclick="game.closeModal()">取消</button>
            </div>
        </div>
    </div>

    <!-- 登录注册弹窗 -->
    <div id="auth-modal" class="modal">
        <div class="modal-content auth-view" style="max-width: 350px;">
            <button class="modal-close" onclick="game.closeModal()">×</button>
            <h2 id="auth-title" style="color: var(--accent-gold); margin-bottom: 20px;">登入轮回</h2>
            <div class="auth-form">
                <div class="form-group" style="margin-bottom: 15px;">
                    <input type="text" id="auth-username" placeholder="道号 (用户名)"
                        style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); color: white; border-radius: 4px;">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <input type="password" id="auth-password" placeholder="密语 (密码)"
                        style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); color: white; border-radius: 4px;">
                </div>
                <div class="auth-actions" style="display: flex; gap: 10px; justify-content: center;">
                    <button class="menu-btn primary small" onclick="game.handleLogin()">登录</button>
                    <button class="menu-btn small" onclick="game.handleRegister()">注册</button>
                </div>
                <p id="auth-message"
                    style="color: #ff6b6b; font-size: 0.9rem; margin-top: 15px; min-height: 1.2em; text-align: center;">
                </p>
            </div>
        </div>
    </div>

    <!-- 存档冲突弹窗 -->
    <div id="save-conflict-modal" class="modal">
        <div class="modal-content" style="max-width: 600px; text-align: center;">
            <h2 style="color: var(--accent-gold); margin-bottom: 20px;">检测到存档冲突</h2>
            <p style="margin-bottom: 20px; line-height: 1.6;">检测到浏览器中有本地存档，同时您已登录账号。<br>请选择如何处理：</p>

            <div style="display: flex; justify-content: space-between; gap: 20px; margin-bottom: 20px;">
                <div
                    style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; flex: 1; border: 1px solid var(--border-color);">
                    <h3 style="color: #4ff; margin-bottom: 10px;">本地进度 (浏览器)</h3>
                    <p id="local-save-info" style="font-size: 0.9rem; color: #ccc; min-height: 40px;">读取中...</p>
                    <button class="menu-btn primary small" onclick="game.resolveSaveConflict('local')"
                        style="width: 100%; margin-top: 10px;">
                        保留本地 (覆盖云端)
                    </button>
                </div>
                <div
                    style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; flex: 1; border: 1px solid var(--border-color);">
                    <h3 style="color: #f4f; margin-bottom: 10px;">云端进度 (服务器)</h3>
                    <p id="cloud-save-info" style="font-size: 0.9rem; color: #ccc; min-height: 40px;">读取中...</p>
                    <button class="menu-btn small" onclick="game.resolveSaveConflict('cloud')"
                        style="width: 100%; margin-top: 10px;">
                        保留云端 (覆盖本地)
                    </button>
                </div>
            </div>
            <p style="font-size: 0.8rem; color: #666;">注意：选择后将不可撤销。如果云端没有存档，建议选择“保留本地”以上传进度。</p>
        </div>
    </div>

    <!-- Save Slots Modal -->
    <div id="save-slots-modal" class="modal">
        <div class="modal-content large" style="width: 1200px; max-width: 95%;">
            <!-- Header removed for compact layout -->
            <div style="margin-top: 20px;"></div>

            <div class="slots-container" id="slots-container">
                <!-- Slots will be injected here -->
            </div>

            <div class="modal-footer" style="margin-top: 20px; display: flex; justify-content: center;">
                <button class="talisman-btn small"
                    onclick="document.getElementById('save-slots-modal').classList.remove('active')"
                    style="width: 120px;">
                    <div class="talisman-paper" style="border-color: #666; background: #222;"></div>
                    <div class="talisman-content">
                        <span class="btn-text" style="color: #aaa; font-size: 1rem;">取消</span>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- 法宝详情弹窗 (New) -->
    <div id="treasure-detail-modal" class="modal">
        <div class="modal-content treasure-detail-view">
            <button class="modal-close" onclick="game.closeModal()">×</button>
            <div class="treasure-detail-layout">
                <div class="treasure-visual-col">
                    <div class="treasure-visual-bg">
                        <div class="visual-particles"></div>
                        <div class="treasure-large-icon" id="detail-icon">📦</div>
                    </div>
                </div>
                <div class="treasure-info-col">
                    <div class="detail-header">
                        <h2 id="detail-name">法宝名称</h2>
                        <div class="detail-sub" id="detail-rarity">稀有度</div>
                    </div>
                    <div class="detail-body">
                        <div class="detail-desc-box">
                            <p id="detail-desc">法宝效果描述...</p>
                        </div>
                        <div class="detail-lore">
                            <i id="detail-lore">“此物乃天地造化，非有缘人不可得。”</i>
                        </div>
                        <div class="detail-source">
                            <span class="source-label">📍 获取途径:</span>
                            <span id="detail-source">未知</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 游戏介绍/设置弹窗 -->
    <div id="settings-modal" class="modal">
        <div class="modal-content settings-view">
            <button class="modal-close" onclick="game.closeModal()">×</button>
            <h2>游戏介绍</h2>
            <div id="settings-options" class="settings-options">
                <!-- 动态生成 -->
            </div>
        </div>
    </div>

    <!-- 成就界面 -->
    <div id="achievements-screen" class="screen">
        <div class="screen-header">
            <button class="back-btn" onclick="game.showScreen('main-menu')">← 返回</button>
            <h2>🏆 成就殿堂</h2>
        </div>
        <div class="achievements-container" id="achievements-container">
            <!-- 动态生成 -->
        </div>
    </div>

    <!-- 净化 (移除卡牌) 莫泰框 (Ink & Gold Redesign) -->
    <div id="purification-modal">
        <div class="purification-bg-layer"></div>
        <div class="purification-ink-overlay"></div>

        <div class="purification-container">
            <div class="purification-header">
                <h2 class="purification-title">净化道心</h2>
                <div class="purification-subtitle">斩断因果 · 去伪存真</div>
            </div>

            <div class="purification-scroll-area">
                <div class="purification-grid" id="purification-grid">
                    <!-- Cards injected here -->
                </div>
            </div>

            <div class="purification-footer">
                <div class="purification-cost" id="purification-cost-display">消耗: 100 灵石</div>
                <button class="purification-btn" onclick="game.closeModal()">取消 (Cancel)</button>
                <button class="purification-btn confirm" id="purification-confirm-btn" disabled>确认移除 (Confirm)</button>
            </div>
        </div>
    </div>

    <!-- 战斗日志 -->
    <div id="battle-log"></div>

    <!-- 加载脚本 -->
    <!-- Bmob SDK -->
    <script src="js/libs/bmob.min.js"></script>
    <script src="js/services/authService.js?v=5.0.1"></script>
    <script src="js/core/elo-calculator.js?v=5.0.1"></script>
    <script src="js/services/pvp-service.js?v=5.0.1"></script>
    <script src="js/data/cards.js?v=5.0.1"></script>
    <script src="js/data/enemies.js?v=5.0.1"></script>
    <script src="js/data/environments.js?v=5.0.1"></script>
    <script src="js/data/fate_ring.js?v=5.0.1"></script>
    <script src="js/data/laws.js?v=5.0.1"></script>
    <script src="js/data/treasures.js?v=5.0.1"></script>
    <script src="js/data/levels.js?v=5.0.1"></script>
    <script src="js/data/boss_mechanics.js?v=5.0.1"></script>
    <script src="js/data/events.js?v=5.0.1"></script>
    <script src="js/data/achievements.js?v=5.0.1"></script>
    <script src="js/data/skills.js?v=5.0.1"></script>
    <script src="js/data/characters.js?v=5.0.1"></script>
    <script src="js/data/shop-items.js?v=5.0.1"></script>
    <script src="js/core/utils.js?v=5.0.1"></script>
    <script src="js/core/card-effects.js?v=5.0.1"></script>
    <script src="js/core/particles.js?v=5.0.1"></script>
    <script src="js/core/ai-controller.js?v=5.0.1"></script>
    <script src="js/entities/ghost-enemy.js?v=5.0.1"></script>
    <script src="js/core/audio.js?v=5.0.1"></script>
    <script src="js/core/events.js?v=5.0.1"></script>
    <script src="js/core/achievements.js?v=5.0.1"></script>
    <script src="js/core/battle.js?v=5.0.1"></script>
    <script src="js/core/map.js?v=5.0.1"></script>
    <script src="js/core/fateRing.js?v=5.0.1"></script>
    <script src="js/core/player.js?v=5.0.1"></script>
    <script src="js/scenes/pvp-scene.js?v=5.0.1"></script>
    <script src="js/game.js?v=5.0.1"></script>
</body>

</html>